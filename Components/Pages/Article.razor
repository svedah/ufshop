@page "/article/{id:guid}"
@using Microsoft.EntityFrameworkCore
@using ufshop.Data.Models
@using ufshop.Services
@using ufshop.Shared
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization


@code {
    //TODO: ska vi stöda /article/Title också? chatgpt vet hur man gör ;)
    private readonly BeService BeService;
    private readonly ArticleService Service;

    [Parameter]
    public Guid id { get; set; }

    public ShopItem shopItem = null;

    public int BuyNumItems { get; set; } = 1;

    public string ImageURL
    {
        get
        {
            if (shopItem is not null && shopItem.PrimaryImage is not null)
            {
                return "/img/" + shopItem.PrimaryImage.Filename;
            }
            return "/img/" + Constants.EMPTYIMAGEFILENAME;
        }
    }

    public string ImageText
    {
        get
        {
            if (shopItem is not null && shopItem.PrimaryImage is not null)
            {
                return shopItem.PrimaryImage.AltText;
            }
            return "Ingen bild";
        }
    }


    public Article(BeService beService)
    {
        BeService = beService;
        Service = new ArticleService(beService);
    }

    protected override async Task OnInitializedAsync()
    {
        if(id.Equals(Guid.Empty))
        {
            //TODO: navigate back or to home page?
        }

        ShopItem item;
        if (Service.GetShopItem(id, out item))
        {
            shopItem = item;
        }
    }

    private async Task AddToCart()
    {
        if (!id.Equals(Guid.Empty) && shopItem is not null && BuyNumItems > 0 && BuyNumItems <= shopItem.ItemsAvailable)
        {

            //TODO
            @* HashSet<CartItemProperty> cartItemProperties = new HashSet<CartItemProperty>(); *@

            CartItem newCartItem = CartService.BuildCartItem(shopItem, BuyNumItems);//, cartItemProperties);

            CartService cartService = new CartService(this.BeService);
            await cartService.AddOrUpdateAsync(newCartItem);
        }
    }

    @* private async Task ClearCart()
    {
        CartService cartService = new CartService(this.BeService);
        await cartService.ClearAsync();
    } *@

    private async Task NumItemsChange()
    {
        if (!id.Equals(Guid.Empty))
        {
            if (BeService.DbContext.ShopItems.Where(e => e.Id.Equals(id)).Any())
            {
                shopItem = await BeService.DbContext.ShopItems.Where(e => e.Id.Equals(id)).FirstAsync();
                BuyNumItems = Math.Min(shopItem.ItemsAvailable, BuyNumItems);
                BuyNumItems = Math.Max(0, BuyNumItems);
            }
        }
    }

    private async Task NavigateBack()
    {
        await BeService.JsRuntime.InvokeVoidAsync("history.back");
    }
}

@if (shopItem is null)
{
    <PageTitle>Hämtar artikel</PageTitle>
    <Spinner />
    <p>Hämtar...</p>
    @* <p>@id</p> *@
}
else
{
    <PageTitle>Visar artikel "@shopItem.Title"</PageTitle>

    <div class="container my-3">
        <div class="row g-4">
            <!-- Vänster Kolumn - Bilder -->
            <div class="col-lg-6">
                <!-- Primär Bild -->
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-3">
                        <!-- Karusell Bilder -->
                        @if (shopItem.Images.Any())
                        { 
                            <Carousel ShowIndicators="true" Autoplay="CarouselAutoPlay.StartOnPageLoad" class="custom-carousel">
                                <CarouselItem Active="true" Interval="3000">
                                    <img src="@ImageURL" alt="@ImageText" class="img-fluid rounded-4 w-100" />
                                </CarouselItem>

                                @foreach(ShopImage shopImage in shopItem.Images)
                                {
                                    string imageUrl = "/img/t/" + shopImage.Filename;
                                    string imageText = shopImage.AltText;
                                    
                                    <CarouselItem>
                                        <img src="@imageUrl" alt="@imageText" class="img-fluid rounded-4 w-100" />
                                    </CarouselItem>
                                }
                            </Carousel>

                            <style>
                                .custom-carousel .carousel-indicators button {
                                    background-color: rgba(255, 255, 255, 0.8);
                                    border: 2px solid rgba(0, 0, 0, 0.5);
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                                    width: 12px;
                                    height: 12px;
                                    border-radius: 50%;
                                }
                                
                                .custom-carousel .carousel-indicators button.active {
                                    background-color: var(--bs-primary);
                                    border-color: white;
                                    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
                                }
                            </style>
                        }
                        else 
                        {
                            <div class="primary-image-container">
                                <img src="@ImageURL" alt="@ImageText" class="img-fluid rounded-4 w-100" />
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Höger Kolumn - Produkt Info -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        
                        <!-- Titel -->
                        <div class="col mb-3">
                            <h1 class="display-6 fw-bold mb-0 d-flex align-items-center text-break">@shopItem.Title</h1>
                        </div>

                        <!-- Price -->
                        <div class="mb-4 pb-4 border-bottom">
                            <div class="d-flex align-items-baseline">
                                <h2 class="display-5 fw-bold text-primary mb-0">@shopItem.Price</h2>
                                <span class="fs-4 text-muted ms-2">kr</span>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mb-4 px-2">
                            <h5 class="fw-semibold mb-2">
                                <i class="bi bi-text-paragraph me-2 text-primary"></i>Beskrivning
                            </h5>
                            <p class="text-muted lead">@shopItem.Description</p>
                        
                        </div>

                        <!-- Availability -->
                        <div class="mb-4">
                            <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-sm-between p-4 bg-light rounded gap-2">
                                <h6 class="fw-semibold mb-0">
                                    <i class="bi bi-box-seam me-2 text-primary"></i>Lagerstatus
                                </h6>
                                <p class="mb-0 text-muted">
                                    @if (shopItem.ItemsAvailable <= 5)
                                    {
                                        <span class="text-warning fw-semibold">
                                            <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                            Endast @shopItem.ItemsAvailable kvar!
                                        </span>
                                    }
                                    else if (shopItem.ItemsAvailable == 0)
                                    {
                                        <span class="text-danger fw-semibold">
                                            <i class="bi bi-x-circle-fill me-1"></i>
                                            Slutsåld
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-success fw-semibold">
                                            <i class="bi bi-check-circle-fill me-1"></i>
                                            @shopItem.ItemsAvailable st i lager
                                        </span>
                                    }
                                </p>
                            </div>
                        </div>

                        <!-- Quantity Selector and Add to Cart -->
                        @if (shopItem.Active && shopItem.ItemsAvailable > 0)
                        {
                            <div class="card bg-primary bg-opacity-10 border-primary border-2">
                                <div class="card-body p-4 text-center">
                                    <label class="form-label fw-semibold mb-3 d-flex align-items-center justify-content-center">
                                        Välj antal
                                    </label>
                                        
                                    <div class="input-group input-group-lg mb-3">
                                        <span class="input-group-text bg-white d-none d-sm-flex">
                                            <i class="bi bi-bag"></i>
                                        </span>
                                        <InputNumber @bind-value="BuyNumItems" 
                                                    min="1" 
                                                    max="@shopItem.ItemsAvailable" 
                                                    @onchange="NumItemsChange"
                                                    class="form-control text-center fw-bold" />
                                        <span class="input-group-text bg-white text-muted">st</span>
                                    </div>                           
                                

                                    <div class="d-grid">
                                        <Button Color="ButtonColor.Primary" 
                                                Size="ButtonSize.Large"
                                                @onclick="AddToCart"
                                                class="py-3">
                                            <i class="bi bi-cart-plus-fill me-2"></i>
                                            Lägg i varukorg
                                        </Button>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning d-flex align-items-center" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <div>
                                    Denna vara är tyvärr inte tillgänglig för tillfället
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}
