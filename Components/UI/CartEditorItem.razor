@using ufshop.Data.Models
@using ufshop.Services
@rendermode InteractiveServer
@code {
    public readonly BeService beService;
    public readonly CartService cartService;

    [Parameter]
    public Guid Id { get; set; }
    [Parameter]
    public EventCallback<Guid> OnChange { get; set; }
    public CartItem Item { get; set; }

    public CartEditorItem(BeService srv)
    {
        beService = srv;
        cartService = new CartService(beService);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            CartItem cartItem = await cartService.GetCartContentItem(Id);
            if (cartItem is not null)
            {
                Item = cartItem;
            }
        }
        StateHasChanged();
    }

    private async Task DecrementAmount()
    {
        Item.Amount = Math.Max(1, Item.Amount - 1);
        await cartService.AddOrUpdateAsync(Item);
        await OnChange.InvokeAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task IncrementAmount()
    {
        Item.Amount = Math.Min(Item.ShopItem.ItemsAvailable, Item.Amount + 1);
        await cartService.AddOrUpdateAsync(Item);
        await OnChange.InvokeAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task DeleteItem()
    {
        await cartService.DeleteAsync(Item);
        await OnChange.InvokeAsync();
        await InvokeAsync(StateHasChanged);
    }

}
@if (Item is not null)
{
    <div class="d-flex justify-content-between" style="max-height: 2.5rem;">
        <div>
            <div class="d-flex">
                @{
                    string imageUrl = "/img/t/" + Item.ShopItem.PrimaryImage.Filename;
                    string imageAlt = Item.ShopItem.PrimaryImage.AltText;
                }
                <Image Src="@imageUrl" Alt="@imageAlt" style="height: 2rem;margin-right: 0.5rem;" />
                <p style="overflow: hidden;text-overflow: ellipsis;">
                    @Item.ShopItem.Title
                </p>
            </div>
        </div>
        @* <div> TODO: ifall en beställning kräver uppladdning skall det synas en knapp för det här. IconName.CloudArrowUp IconName.CloudCheck </div>*@
        <div>
            <Button Color="ButtonColor.Primary" Size="ButtonSize.ExtraSmall" @onclick="DecrementAmount">
                <Icon Name="IconName.Dash" />
            </Button>
            <InputNumber @bind-Value="@Item.Amount" min="1" max="@Item.ShopItem.ItemsAvailable" Disabled="true" style="width:3rem;text-align:right;" /> 
            <Button Color="ButtonColor.Primary" Size="ButtonSize.ExtraSmall" @onclick="IncrementAmount">
                <Icon Name="IconName.Plus" />
            </Button>
            <Button Color="ButtonColor.Danger" Size="ButtonSize.ExtraSmall" @onclick="DeleteItem">
                <Icon Name="IconName.Trash" />
            </Button>
        </div>
    </div>
}
