@using System.Collections.Immutable
@using System.Reflection.Metadata
@using ufshop.Data.Models
@using ufshop.Services
@using ufshop.Shared
@namespace ufshop.Components.UI
@rendermode InteractiveServer

@code {

    public readonly BeService beService;
    public readonly ManageCreateItemService Service;

    public readonly string FormTitleId = Guid.NewGuid().ToString();
    public readonly string FormDescriptionId = Guid.NewGuid().ToString();
    public readonly string FormItemsAvailableId = Guid.NewGuid().ToString();
    public readonly string FormItemsPriceId = Guid.NewGuid().ToString();
    public readonly string FormItemsOrderId = Guid.NewGuid().ToString();
    public readonly string FormPrimaryImageId = Guid.NewGuid().ToString();
    public readonly string FormImagesId = Guid.NewGuid().ToString();
    public readonly string FormActiveId = Guid.NewGuid().ToString();


    ShopItem newShopItem = new ShopItem
    {
        Id = Guid.Empty,
        Active = false,
        Title = string.Empty,
        Description = string.Empty,
        ItemsAvailable = 0,
        Price = 0,
        Order = 0,
        PrimaryImage = new ShopImage
        {
            Id = Guid.Empty,
            Created = DateTime.Now,
            Filename = Constants.EMPTYIMAGEFILENAME,
            AltText = "BildBeskrivning"
        },
        Images = new HashSet<ShopImage>(),
        Properties = new HashSet<ShopItemProperty>()
    };

    public ManageCreateItem(BeService srv)
    {
        beService = srv;
        Service = new ManageCreateItemService(srv);
    }

    private async Task HandleSelectedPrimaryImage(string value)
    {
        Guid Id = Guid.Parse(value);
        var iss = new ImageSelectorService(beService);
        ShopImage image = null;
        bool result = iss.GetImage(Id, ref image);
        if (result)
        {
            newShopItem.PrimaryImage = image;
        }
    }

    private async Task HandleSelectedCarouselImage(string value)
    {
        Guid Id = Guid.Parse(value);

        ShopService ss = new ShopService(beService);
        Shop shop;
        if (ss.GetShop(beService.DomainPrefix, out shop))
        {
            if (shop.Images.Where(e=>e.Id.Equals(Id)).Any())
            {
                ShopImage shopImage = shop.Images.Where(e=>e.Id.Equals(Id)).First();
                if (newShopItem.Images.Where(e=>e.Id.Equals(Id)).Any())
                {
                    newShopItem.Images.Remove(shopImage);
                }
                else
                {
                    newShopItem.Images.Add(shopImage);
                }
            }

        }
    }

    private async Task CreateNewItem()
    {
        Service.CreateNew(newShopItem);
    }

    private bool CanCreateNewItem
    {
        get
        {
            return Service.CanCreateNew(newShopItem);
        }
    }
}


<section class="mx-4 my-4">

<div class="row">
    <div class="col text-center fw-bold">
        <h1>Skapa vara</h1>
    </div>
</div>


<!-- Main Form Card -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-body p-4">

        @* Titel *@
        <div class="mb-4">
            <label class="form-label fw-semibold" for="@FormTitleId">
                <i class="bi bi-tag me-2"></i>Titel
            </label>
            <InputText class="form-control" id="@FormTitleId" @bind-Value="@newShopItem.Title" />
        </div>


        @* Beskrivning *@
        <div class="mb-4">
            <label class="form-label fw-semibold" for="@FormDescriptionId">
                <i class="bi bi-text-paragraph me-2"></i>Beskrivning
            </label>
            <TextAreaInput class="form-control" id="@FormDescriptionId" Rows="5" @bind-Value="@newShopItem.Description" />
        </div>

        
        @* Pris och tillgång del *@
        <div class="row g-3 mb-4">

            <div class="col-md-4">
                <label class="form-label fw-semibold" for="@FormItemsPriceId">
                    <i class="bi bi-currency-dollar me-2"></i>Pris
                </label>

                <div class="input-group input-group-lg">
                    <InputNumber class="form-control text-center" id="@FormItemsPriceId" @bind-Value="@newShopItem.Price" Min="0" Max="10000" />
                    <span class="input-group-text">kr</span>
                </div>
            </div>


            <div class="col-md-4">
                <label class="form-label fw-semibold" for="@FormItemsAvailableId">
                    <i class="bi bi-box-seam me-2"></i>Antal tillgängliga
                </label>
                <InputNumber class="form-control form-control-lg text-center" id="@FormItemsAvailableId" @bind-Value="@newShopItem.ItemsAvailable" Min="1" Max="1000" />
            </div>


            <div class="col-md-4">
                <label class="form-label fw-semibold" for="@FormItemsOrderId">
                    <i class="bi bi-sort-numeric-down me-2"></i>Sorteringsordning
                </label>
                <InputNumber class="form-control form-control-lg text-center" id="@FormItemsOrderId" @bind-Value="@newShopItem.Order" Min="1" Max="10000" />
            </div>

        </div>
    </div>
</div>





@* Bild väljare *@

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom py-3">
        <h5 class="mb-0 fw-semibold">
            <i class="bi bi-images me-2 text-primary"></i>Bilder
        </h5>
    </div>
    <div class="card-body p-4">
        <Accordion>
            <AccordionItem Title="Primär bild">
                <Content>
                    <ImageSelector Image=@newShopItem.PrimaryImage OnValueSelected="HandleSelectedPrimaryImage"/>
                </Content>
            </AccordionItem>
            <AccordionItem Title="Karusellbilder">
                <Content>
                    <ImagesSelector Images=@newShopItem.Images OnValueSelected="HandleSelectedCarouselImage" />
                </Content>
            </AccordionItem>
        </Accordion>
    </div>
</div>


@* Bild förhandsgranskning *@

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom py-3">
        <h5 class="mb-0 fw-semibold">
            <i class="bi bi-eye me-2 text-primary"></i>Förhandsgranskning
        </h5>
    </div>

    <div class="card-body container p-4">
        <div class="row">
            @* Primär bild *@
            <div class="col-md mb-4 d-grid justify-content-center">
                <label class="form-label text-center fw-semibold text-muted small mb-3">PRIMÄR BILD</label>
                
                @{
                    string imageFile = "/img/" + newShopItem.PrimaryImage.Filename;
                }

                <Image Src="@imageFile" Alt="@newShopItem.PrimaryImage.AltText" 
                class="rounded border border-3 shadow-sm" style="width: 200px; height: 200px; object-fit: cover;" />
                    
            </div>

            <!-- Karusell bilder -->
            @if(newShopItem.Images.Any())
            {
                <div class="col-md-7 d-grid justify-content-center">
                    <label class="form-label text-center fw-semibold mb-3 text-muted small">KARUSELLBILDER</label>
                
                    <div class="d-flex gap-3">
                    @foreach(ShopImage image in @newShopItem.Images.OrderBy(e=>e.Created))
                    {
                        string imageFileName = "/img/t/" + image.Filename;
                        @* <div class="border rounded p-2 bg-light"> *@
                        <Image Src="@imageFileName" IsThumbNail="true" 
                        Alt="@newShopItem.PrimaryImage.AltText" class="rounded border border-2 shadow-sm"
                        style="width: 120px; height: 120px; object-fit: cover;"/>
                        @* </div> *@
                    }
                    </div>            
                </div>
            }
        </div>
    </div>
</div>

<!-- Publicera och spara -->
    <div class="card container shadow-sm border-0 mb-4">
        <div class="card-body row p-4">
            <div class="col-lg col-md">
                <div class="form-check form-switch form-check-reverse text-start d-flex justify-content-start mb-3">
                    <CheckboxInput id="FormActiveId" class="form-check-input" 
                                Label="Publicera varan direkt" @bind-Value="@newShopItem.Active" />
                </div>
                <small class="text-muted d-block mt-1 mx-4 my-2">
                    Varan blir synlig i butiken när den är publicerad
                </small>
            </div>

            <div class="col-lg col-md d-grid gap-2 d-md-flex justify-content-md-end align-items-center my-sm-4">
                <Button Color="ButtonColor.Primary" Size="ButtonSize.Large" class="fw-bold px-lg-5 px-md-4"
                        @onclick="CreateNewItem" Disabled="!CanCreateNewItem">
                    Spara vara
                </Button>
            </div>
        </div>
    </div>
</section>