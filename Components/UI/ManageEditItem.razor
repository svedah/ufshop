@using System.Collections.Immutable
@using System.Reflection.Metadata
@using ufshop.Data.Models
@using ufshop.Services
@using ufshop.Shared
@namespace ufshop.Components.UI
@rendermode InteractiveServer

@code {

    public readonly BeService beService;
    public readonly ManageEditItemService Service;

    public readonly string FormTitleId = Guid.NewGuid().ToString();
    public readonly string FormDescriptionId = Guid.NewGuid().ToString();
    public readonly string FormItemsAvailableId = Guid.NewGuid().ToString();
    public readonly string FormItemsPriceId = Guid.NewGuid().ToString();
    public readonly string FormItemsOrderId = Guid.NewGuid().ToString();
    public readonly string FormPrimaryImageId = Guid.NewGuid().ToString();
    public readonly string FormImagesId = Guid.NewGuid().ToString();
    public readonly string FormRabattId = Guid.NewGuid().ToString();
    public readonly string FormActiveId = Guid.NewGuid().ToString();

    ShopItem editShopItem = new ShopItem
    {
        Id = Guid.Empty,
        Active = false,
        Title = string.Empty,
        Description = string.Empty,
        ItemsAvailable = 0,
        Price = 0,
        Order = 0,
        PrimaryImage = new ShopImage
        {
            Id = Guid.Empty,
            Created = DateTime.Now,
            Filename = Constants.EMPTYIMAGEFILENAME,
            AltText = "BildBeskrivning"
        },
        Images = new HashSet<ShopImage>(),
        Uploadable = false,
        Rabatt = false
        @* Properties = new HashSet<ShopItemProperty>() *@
    };

    public ManageEditItem(BeService srv)
    {
        beService = srv;
        Service = new ManageEditItemService(srv);
    }

    @* protected override async Task OnInitializedAsync()
    {

    } *@

    private void HandleSelectedPrimaryImage(string value)
    {
        Guid Id = Guid.Parse(value);
        var iss = new ImageSelectorService(beService);
        ShopImage image = default!;
        bool result = iss.GetImage(Id, ref image);
        if (result)
        {
            editShopItem.PrimaryImage = image;
        }
    }

    private void HandleSelectedCarouselImage(string value)
    {
        Guid Id = Guid.Parse(value);

        ShopService ss = new ShopService(beService);
        Shop shop;
        if (ss.GetShop(beService.DomainPrefix, out shop))
        {
            if (shop.Images.Where(e=>e.Id.Equals(Id)).Any())
            {
                ShopImage shopImage = shop.Images.Where(e=>e.Id.Equals(Id)).First();
                if (editShopItem.Images.Where(e=>e.Id.Equals(Id)).Any())
                {
                    editShopItem.Images.Remove(shopImage);
                }
                else
                {
                    editShopItem.Images.Add(shopImage);
                }
            }
        }
    }

    private void EditItem()
    {
        Service.Edit(editShopItem);
    }

    private bool CanEditItem
    {
        get
        {
            return !Service.CanEditItem(editShopItem);
        }
    }

    private void SelectItemChange(ChangeEventArgs e)
    {
        Guid SelectedId = Guid.Empty;
        if (e is not null && e.Value is not null)
        {
            if (Guid.TryParse(e.Value.ToString(), out SelectedId))
            {
                ShopItem shopItem;
                if (Service.GetShopItem(SelectedId, out shopItem))
                {
                    editShopItem = shopItem;
                }
            }
        }
    }

    public List<ShopItem> AllShopItems = new List<ShopItem>();
    public void UpdateAllShopItems()
    {
        AllShopItems = Service.AllShopItems().ToList();
    }


}
<section class="mx-4 my-4">

    <div class="row m-4">
        <div class="col text-center text-primary">
            <h1 class="display-5 fw-bold">RedJKYG   igera Vara hejhejhe</h1>
        </div>
    </div>

    <h1>CanEditItem: @CanEditItem</h1>

    @* Välj vara *@
    <div class="select-item-container mb-4">
        <label class="form-label fw-semibold mb-2">
            <i class="bi bi-box-seam me-2 text-primary"></i>Välj vara att redigera
        </label>
        
        <div class="select-wrapper">
            <select class="form-select form-select-lg shadow-sm" 
                    @onchange="SelectItemChange" 
                    @onclick="UpdateAllShopItems">
                <option selected disabled>
                    Välj vara från listan
                </option>
                @foreach(ShopItem item in AllShopItems)
                {
                    string active = item.Active ? string.Empty : "ej";
                    <option value="@item.Id">
                        @item.Title • @item.ItemsAvailable st • @active publicerad
                    </option>
                }
            </select>
        </div> 
    </div>
        

    @if (editShopItem.Id != Guid.Empty)
    {

    <!-- Main Form Card -->
    <div class="card shadow border-0 mb-4">
        <div class="card-body p-4">

            @* Titel *@
            <div class="mb-4">
                <label class="form-label fw-semibold" for="@FormTitleId">
                    <i class="bi bi-tag me-2"></i>Titel
                </label>
                <InputText class="form-control" id="@FormTitleId" @bind-Value="@editShopItem.Title" />
            </div>


            @* Beskrivning *@
            <div class="mb-4">
                <label class="form-label fw-semibold" for="@FormDescriptionId">
                    <i class="bi bi-text-paragraph me-2"></i>Beskrivning
                </label>
                <TextAreaInput class="form-control" id="@FormDescriptionId" Rows="5" @bind-Value="@editShopItem.Description" />
            </div>



            @* Pris och tillgång del *@
            <div class="row g-3 mb-4">

                <div class="col-md-4">
                    <label class="form-label fw-semibold" for="@FormItemsPriceId">
                        <i class="bi bi-currency-dollar me-2"></i>Pris
                    </label>

                    <div class="input-group input-group-lg">
                        <NumberInput class="form-control text-center" id="@FormItemsPriceId" @bind-Value="@editShopItem.Price" EnableMinMax="true" Min="0" Max="10000" />
                        <span class="input-group-text">kr</span>
                    </div>  
                </div>


                <div class="col-md-4">
                    <label class="form-label fw-semibold" for="@FormItemsAvailableId">
                        <i class="bi bi-box-seam me-2"></i>Antal tillgängliga
                    </label>
                    <NumberInput class="form-control form-control-lg text-center" id="@FormItemsAvailableId" @bind-Value="@editShopItem.ItemsAvailable" Min="1" Max="1000" />
                </div>


                <div class="col-md-4">
                    <label class="form-label fw-semibold" for="@FormItemsOrderId">
                        <i class="bi bi-sort-numeric-down me-2"></i>Sorteringsordning
                    </label>
                    <NumberInput class="form-control form-control-lg text-center" id="@FormItemsOrderId" @bind-Value="@editShopItem.Order" Min="1" Max="10000" />
                </div>
            </div>
        </div>
    </div>


    @* Bild väljare *@


    <div class="card shadow border-0 mb-4">
        <div class="card-header bg-white border-bottom px-4 py-3">
            <h5 class="mb-0 fw-semibold">
                <i class="bi bi-images me-2 text-primary"></i>Bilder
            </h5>
        </div>
        <div class="card-body p-4">
            <Accordion>
                <AccordionItem Title="Primär bild">
                    <Content>
                        <ImageSelector Image=@editShopItem.PrimaryImage OnValueSelected="HandleSelectedPrimaryImage"/>
                    </Content>
                </AccordionItem>
                <AccordionItem Title="Karusellbilder">
                    <Content>
                        <ImagesSelector Images=@editShopItem.Images OnValueSelected="HandleSelectedCarouselImage" />
                    </Content>
                </AccordionItem>
            </Accordion>
        </div>
    </div>

    @* Bild förhandsgranskning *@

    <div class="card shadow border-0 mb-4">
        <div class="card-header bg-white border-bottom px-4 py-3">
            <h5 class="mb-0 fw-semibold">
                <i class="bi bi-eye me-2 text-primary"></i>Förhandsgranskning
            </h5>
        </div>

        <div class="card-body container p-4">
            <div class="row">
                @* Primär bild *@
                <div class="col-md mb-4 d-grid justify-content-center">
                    <label class="form-label text-center fw-semibold text-muted  mb-3">PRIMÄR BILD</label>
                    
                    @{
                        string imageFile = "/img/" + editShopItem.PrimaryImage.Filename;
                    }

                    <Image Src="@imageFile" Alt="@editShopItem.PrimaryImage.AltText" 
                    class="rounded-4 border border-3 shadow-sm" style="width: 200px; height: 200px; object-fit: cover;" />
                        
                </div>

                <!-- Karusell bilder -->
                @if(editShopItem.Images.Any())
                {
                    <div class="col-md-7 d-grid justify-content-center">
                        <label class="form-label text-center fw-semibold mb-3 text-muted">KARUSELLBILDER</label>
                    
                        <div class="d-flex gap-3">
                        @foreach(ShopImage image in @editShopItem.Images.OrderBy(e=>e.Created))
                        {
                            string imageFileName = "/img/t/" + image.Filename;
                            @* <div class="border rounded p-2 bg-light"> *@
                            <Image Src="@imageFileName" IsThumbNail="true" 
                            Alt="@editShopItem.PrimaryImage.AltText" class="rounded-4 border border-2 shadow-sm"
                            style="width: 120px; height: 120px; object-fit: cover;"/>
                            @* </div> *@
                        }
                        </div>            
                    </div>
                }
            </div>
        </div>
    </div>


    <!-- Publicera, Rabattera och spara -->
    <div class="card container shadow border-0 mb-4">
        <div class="card-body row p-4">
            <div class="col-lg col-md d-flex flex-column justify-content-center">
                <div class="form-check form-switch form-check-reverse text-start d-flex justify-content-start align-items-center mb-3">
                    <CheckboxInput id="FormActiveId" class="form-check-input" 
                                Label="Publicera varan direkt" @bind-Value="@editShopItem.Active" />
                </div>
                <small class="text-muted d-block mt-1 mx-4 my-2 mb-sm-1 d-flex align-items-center">
                    Varan blir synlig i butiken när den är publicerad
                </small>

                <div class="form-check form-switch form-check-reverse text-start d-flex justify-content-start align-items-center mb-3">
                    <CheckboxInput id="FormRabattId" class="form-check-input" 
                                Label="Rabattera varan direkt" @bind-Value="@editShopItem.Rabatt" />
                </div>
                <small class="text-muted d-block mt-1 mx-4 my-2 mb-sm-1 d-flex align-items-center">
                    Varan visar rabatt notis
                </small>
            </div>

            <div class="col-lg col-md d-grid gap-2 d-md-flex justify-content-md-end align-items-center my-sm-4">
                <Button Color="ButtonColor.Primary" Size="ButtonSize.Large" class="fw-bold px-lg-5 px-md-4"
                        @onclick="EditItem" Disabled="!CanEditItem">
                    Spara vara
                </Button>
            </div>
        </div>
    </div>
    }

</section>
