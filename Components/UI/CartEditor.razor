@using ufshop.Data.Models
@using ufshop.Services
@rendermode InteractiveServer
@code {
    public readonly BeService beService;
    public readonly CartService cartService;
    public List<KeyValuePair<ShopItem, int>> CartContent;
    public readonly int ShippingPrice = -1;

    public int CartContentSum
    {
        get
        {
            int output = 0;
            foreach(KeyValuePair<ShopItem, int> kvp in CartContent)
            {
                output += kvp.Key.Price * kvp.Value;
            }
            return output;
        }
    }

    
    public CartEditor(BeService srv)
    {
        beService = srv;
        cartService = new CartService(beService);
        CartContent = new List<KeyValuePair<ShopItem, int>>();
        ShippingPrice = GetShippingPrice();
    }

    private int GetShippingPrice()
    {
        Shop shop;
        ShopService ss = new ShopService(beService);
        if (ss.GetShop(beService.DomainPrefix, out shop))
        {
            return shop.Settings.BaseShippingPrice;
        }
        return ufshop.Shared.Constants.BASESHIPPINGPRICE;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            CartContent = await cartService.GetCartContent();
        }
        StateHasChanged();
    }

    private async Task HandleDeleteItem()
    {
        var cartContent = await cartService.GetCartContent();
        CartContent = cartContent;
        await InvokeAsync(StateHasChanged);
    }

}
<h2 class="d-flex justify-content-between align-items-center mb-3">
    <span>Varukorgen</span>
    <span>@CartContent.Count</span>
</h2>

<ul class="list-group mb-3">
    @foreach(KeyValuePair<ShopItem, int> kvp in CartContent)
    {
        <li class="list-group-item lh-condensed"> @* class="list-group-item d-flex justify-content-between lh-condensed"> *@
            <CartEditorItem @key="@kvp.Key.Id" Id="@kvp.Key.Id" OnDelete="HandleDeleteItem" />
        </li>
    }
</ul>

@if (CartContent.Count > 0)
{
    <p>
    Varupris: @CartContentSum
    </p>
    <p>
    Fraktpris: @ShippingPrice
    </p>

    <p>
    Totalt: @CartContentSum + @ShippingPrice
    </p>

    <Button Color="ButtonColor.Primary">KÃ¶p</Button>
}


